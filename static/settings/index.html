<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings | CodeChicks</title>
    <meta name="description" content="Manage your CodeChicks account settings">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/settings/style.css?v=2">
    <link rel="stylesheet" href="/static/css/timer-overlay.css?v=2">
</head>

<body>
    <!-- Auth check - redirects if no token -->
    <script src="/static/js/auth.js"></script>

    <div class="background-overlay"></div>

    <div class="settings-container">
        <!-- Header -->
        <header class="settings-header glass-panel">
            <div class="header-left">
                <div class="logo">
                    <span class="logo-icon">üê£</span>
                    <span class="logo-text">CodeChicks</span>
                </div>
            </div>
            <div class="header-center">
                <h1 class="page-title">‚öôÔ∏è Settings</h1>
            </div>
            <div class="header-right">
                <span class="role-badge" id="roleBadge">USER</span>
                <button class="logout-btn glass-btn" onclick="confirmLogout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>

        <!-- Sidebar Navigation -->
        <nav class="sidebar glass-panel">
            <ul class="nav-links">
                <li><a href="/dashboard"><i class="fas fa-chart-pie"></i> Dashboard</a></li>
                <li><a href="/chat"><i class="fas fa-comments"></i> Chat</a></li>
                <li><a href="/clock"><i class="fas fa-clock"></i> Timer</a></li>
                <li class="active"><a href="/settings"><i class="fas fa-cog"></i> Settings</a></li>
            </ul>
            <div class="admin-link" id="adminLink" style="display: none;">
                <a href="/admin" class="admin-btn">
                    <i class="fas fa-crown"></i> Admin Panel
                </a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="settings-main">
            <!-- Profile Section -->
            <section class="settings-card glass-panel">
                <div class="card-header">
                    <h2 class="card-title">üë§ Profile</h2>
                    <span class="card-subtitle" id="profileStatus">Loading...</span>
                </div>
                <div class="card-body">
                    <div class="profile-loading" id="profileLoading">
                        <i class="fas fa-spinner fa-spin"></i> Loading profile...
                    </div>

                    <form id="profileForm" style="display: none;" onsubmit="updateProfile(event)">
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="email">Email</label>
                                <input type="email" id="email" disabled>
                            </div>

                            <div class="input-group">
                                <label for="username">Username</label>
                                <input type="text" id="username" minlength="3" maxlength="30"
                                    placeholder="Choose a username">
                            </div>

                            <div class="input-group">
                                <label for="displayName">Display Name</label>
                                <input type="text" id="displayName" maxlength="50" placeholder="How others see you">
                            </div>

                            <div class="input-group">
                                <label for="age">Age</label>
                                <input type="number" id="age" min="13" max="120" placeholder="Your age">
                            </div>
                        </div>

                        <div class="input-group full-width">
                            <label for="bio">Bio</label>
                            <textarea id="bio" maxlength="500" rows="3"
                                placeholder="Tell us about yourself..."></textarea>
                        </div>

                        <div id="updateMessage" class="update-message"></div>

                        <button type="submit" class="btn-primary" id="updateBtn">
                            <span id="btnText"><i class="fas fa-save"></i> Save Changes</span>
                            <div class="spinner" id="btnSpinner" style="display: none;"></div>
                        </button>
                    </form>
                </div>
            </section>

            <!-- Password Change Section -->
            <section class="settings-card glass-panel">
                <div class="card-header">
                    <h2 class="card-title">üîë Change Password</h2>
                </div>
                <div class="card-body">
                    <form id="passwordForm" onsubmit="changePassword(event)">
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="currentPassword">Current Password</label>
                                <input type="password" id="currentPassword" required
                                    placeholder="Enter current password">
                            </div>
                            <div class="input-group">
                                <label for="newPassword">New Password</label>
                                <input type="password" id="newPassword" minlength="8" required
                                    placeholder="Min 8 characters">
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="confirmPassword">Confirm New Password</label>
                            <input type="password" id="confirmPassword" minlength="8" required
                                placeholder="Confirm new password">
                        </div>

                        <div id="passwordMessage" class="update-message"></div>

                        <button type="submit" class="btn-secondary" id="passwordBtn">
                            <span id="passwordBtnText"><i class="fas fa-key"></i> Change Password</span>
                            <div class="spinner" id="passwordSpinner" style="display: none;"></div>
                        </button>
                    </form>
                </div>
            </section>

            <!-- Admin Access Section -->
            <section class="settings-card glass-panel" id="adminSection">
                <div class="card-header">
                    <h2 class="card-title">üëë Admin Access</h2>
                </div>
                <div class="card-body">
                    <div id="adminUpgradeSection">
                        <p class="section-desc">Enter the admin key to upgrade to admin role:</p>
                        <form id="adminKeyForm" onsubmit="upgradeToAdmin(event)">
                            <div class="input-group">
                                <label for="adminKey">Admin Key</label>
                                <input type="password" id="adminKey" required placeholder="Enter admin key">
                            </div>
                            <div id="adminMessage" class="update-message"></div>
                            <button type="submit" class="btn-admin" id="adminBtn">
                                <span id="adminBtnText"><i class="fas fa-crown"></i> Upgrade to Admin</span>
                                <div class="spinner" id="adminSpinner" style="display: none;"></div>
                            </button>
                        </form>
                    </div>
                    <div id="adminDowngradeSection" style="display: none;">
                        <p class="section-desc">You are currently an admin. You can downgrade to regular user:</p>
                        <button class="btn-danger" onclick="downgradeToUser()">
                            <i class="fas fa-user"></i> Downgrade to User
                        </button>
                    </div>
                </div>
            </section>

            <!-- Account Section -->
            <section class="settings-card glass-panel">
                <div class="card-header">
                    <h2 class="card-title">üîê Account</h2>
                </div>
                <div class="card-body">
                    <div class="settings-actions">
                        <button class="btn-danger" onclick="confirmLogout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </section>

            <!-- About Section -->
            <section class="settings-card glass-panel">
                <div class="card-header">
                    <h2 class="card-title">‚ÑπÔ∏è About</h2>
                </div>
                <div class="card-body">
                    <div class="app-info">
                        <div class="info-row">
                            <span class="info-label">App</span>
                            <span class="info-value">CodeChicks v1.0.0</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Timezone</span>
                            <span class="info-value">IST (UTC+5:30)</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Member Since</span>
                            <span class="info-value" id="memberSince">--</span>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>



    <script src="/static/js/timer-overlay.js"></script>
    <script>
        let currentProfile = null;
        let currentRole = 'user';

        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserRole();
            await loadProfile();
        });

        async function loadUserRole() {
            try {
                const response = await authFetch('/auth/me');
                if (!response || !response.ok) return;

                const user = await response.json();
                currentRole = user.role;

                // Handle Password UI
                const currentPasswordGroup = document.getElementById('currentPassword').parentElement;
                const passwordBtnText = document.getElementById('passwordBtnText');
                const passwordCardTitle = document.querySelector('#passwordForm').closest('.card-body').previousElementSibling.querySelector('.card-title');

                if (user.has_password === false) {
                    // User has no password (OAuth) -> Setup Mode
                    currentPasswordGroup.style.display = 'none';
                    document.getElementById('currentPassword').required = false;
                    passwordBtnText.innerHTML = '<i class="fas fa-lock"></i> Set Password';
                    passwordCardTitle.textContent = 'üîë Set Password';
                    // Fix alignment: Make grid 1 column so New Password is full width
                    document.querySelector('#passwordForm .form-grid').style.gridTemplateColumns = '1fr';
                } else {
                    // User has password -> Change Mode
                    currentPasswordGroup.style.display = 'block';
                    document.getElementById('currentPassword').required = true;
                    passwordBtnText.innerHTML = '<i class="fas fa-key"></i> Change Password';
                    passwordCardTitle.textContent = 'üîë Change Password';
                    // Revert to 2 columns
                    document.querySelector('#passwordForm .form-grid').style.gridTemplateColumns = '1fr 1fr';
                }

                // Update UI based on role
                const badge = document.getElementById('roleBadge');
                if (user.role === 'admin') {
                    badge.textContent = 'ADMIN';
                    badge.classList.add('admin');
                    document.getElementById('adminLink').style.display = 'block';
                    document.getElementById('adminUpgradeSection').style.display = 'none';
                    document.getElementById('adminDowngradeSection').style.display = 'block';
                } else {
                    badge.textContent = 'USER';
                    badge.classList.remove('admin');
                    document.getElementById('adminLink').style.display = 'none';
                    document.getElementById('adminUpgradeSection').style.display = 'block';
                    document.getElementById('adminDowngradeSection').style.display = 'none';
                }
            } catch (error) {
                console.error('Role check failed:', error);
            }
        }

        async function loadProfile() {
            try {
                const response = await authFetch('/api/profile');
                if (!response || !response.ok) {
                    document.getElementById('profileLoading').innerHTML =
                        '<div class="error"><i class="fas fa-exclamation-triangle"></i> Failed to load profile</div>';
                    document.getElementById('profileStatus').textContent = 'Error';
                    return;
                }

                currentProfile = await response.json();

                // Hide loading, show form
                document.getElementById('profileLoading').style.display = 'none';
                document.getElementById('profileForm').style.display = 'block';
                document.getElementById('profileStatus').textContent = currentProfile.profile_complete ? 'Complete' : 'Incomplete';

                // Populate form
                document.getElementById('email').value = currentProfile.email;
                document.getElementById('username').value = currentProfile.username || '';
                document.getElementById('displayName').value = currentProfile.display_name || '';
                document.getElementById('age').value = currentProfile.age || '';
                document.getElementById('bio').value = currentProfile.bio || '';

                // Member since
                if (currentProfile.created_at) {
                    const date = new Date(currentProfile.created_at);
                    document.getElementById('memberSince').textContent = date.toLocaleDateString('en-IN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        timeZone: 'Asia/Kolkata'
                    });
                }
            } catch (error) {
                console.error('Profile load error:', error);
                document.getElementById('profileLoading').innerHTML =
                    '<div class="error"><i class="fas fa-exclamation-triangle"></i> Network error</div>';
            }
        }

        async function updateProfile(event) {
            event.preventDefault();

            const btn = document.getElementById('updateBtn');
            const btnText = document.getElementById('btnText');
            const spinner = document.getElementById('btnSpinner');
            const message = document.getElementById('updateMessage');

            const updates = {
                username: document.getElementById('username').value.trim() || null,
                display_name: document.getElementById('displayName').value.trim() || null,
                age: document.getElementById('age').value ? parseInt(document.getElementById('age').value) : null,
                bio: document.getElementById('bio').value.trim() || null
            };

            message.textContent = '';
            message.className = 'update-message';
            btn.disabled = true;
            btnText.style.display = 'none';
            spinner.style.display = 'block';

            try {
                const response = await authFetch('/api/profile', {
                    method: 'PATCH',
                    body: JSON.stringify(updates)
                });

                if (!response) return;

                const data = await response.json();

                if (response.ok) {
                    message.textContent = '‚úì Profile updated successfully!';
                    message.className = 'update-message success';
                    currentProfile = data;
                    document.getElementById('profileStatus').textContent = data.profile_complete ? 'Complete' : 'Incomplete';
                } else {
                    message.textContent = data.detail || 'Failed to update profile.';
                    message.className = 'update-message error';
                }
            } catch (error) {
                message.textContent = 'Network error. Please try again.';
                message.className = 'update-message error';
            } finally {
                btn.disabled = false;
                btnText.style.display = 'flex';
                spinner.style.display = 'none';
            }
        }

        async function changePassword(event) {
            event.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const message = document.getElementById('passwordMessage');
            const btn = document.getElementById('passwordBtn');
            const btnText = document.getElementById('passwordBtnText');
            const spinner = document.getElementById('passwordSpinner');

            // Validate passwords match
            if (newPassword !== confirmPassword) {
                message.textContent = 'New passwords do not match';
                message.className = 'update-message error';
                return;
            }

            message.textContent = '';
            btn.disabled = true;
            btnText.style.display = 'none';
            spinner.style.display = 'block';

            try {
                const response = await authFetch('/api/profile/password', {
                    method: 'POST',
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });

                if (!response) throw new Error('No response from server');

                const data = await response.json();

                if (response.ok) {
                    message.textContent = '‚úì Password changed successfully!';
                    message.className = 'update-message success';
                    document.getElementById('passwordForm').reset();
                } else {
                    message.textContent = data.detail || 'Failed to change password.';
                    message.className = 'update-message error';
                }
            } catch (error) {
                message.textContent = 'Network error. Please try again.';
                message.className = 'update-message error';
            } finally {
                btn.disabled = false;
                btnText.style.display = 'flex';
                spinner.style.display = 'none';
            }
        }

        async function upgradeToAdmin(event) {
            event.preventDefault();

            const adminKey = document.getElementById('adminKey').value;
            const message = document.getElementById('adminMessage');
            const btn = document.getElementById('adminBtn');
            const btnText = document.getElementById('adminBtnText');
            const spinner = document.getElementById('adminSpinner');

            message.textContent = '';
            btn.disabled = true;
            btnText.style.display = 'none';
            spinner.style.display = 'block';

            try {
                const response = await authFetch('/auth/upgrade-to-admin', {
                    method: 'POST',
                    body: JSON.stringify({ admin_key: adminKey })
                });

                if (!response) throw new Error('No response from server');

                const data = await response.json();

                if (response.ok) {
                    message.textContent = '‚úì ' + data.message;
                    message.className = 'update-message success';
                    document.getElementById('adminKeyForm').reset();
                    // Reload to update UI
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    message.textContent = data.detail || 'Invalid admin key';
                    message.className = 'update-message error';
                }
            } catch (error) {
                message.textContent = 'Network error. Please try again.';
                message.className = 'update-message error';
            } finally {
                btn.disabled = false;
                btnText.style.display = 'flex';
                spinner.style.display = 'none';
            }
        }

        async function downgradeToUser() {
            if (!confirm('Are you sure you want to downgrade to regular user?')) return;

            try {
                const response = await authFetch('/auth/downgrade-to-user', {
                    method: 'POST'
                });

                if (!response) return;

                const data = await response.json();

                if (response.ok) {
                    alert(data.message);
                    window.location.reload();
                } else {
                    alert(data.detail || 'Failed to downgrade');
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        }

        function confirmLogout() {
            if (confirm('Are you sure you want to logout?')) {
                logout();
            }
        }
    </script>
</body>

</html>