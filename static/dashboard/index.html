<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | CodeChicks</title>
    <meta name="description" content="Your personal CodeChicks dashboard">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/dashboard/style.css?v=2">
    <link rel="stylesheet" href="/static/css/timer-overlay.css?v=2">
</head>

<body>
    <!-- Auth check - redirects if no token -->
    <script src="/static/js/auth.js"></script>

    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header glass-panel">
            <div class="header-left">
                <div class="logo">
                    <span class="logo-icon">üê£</span>
                    <span class="logo-text">CodeChicks</span>
                </div>
            </div>
            <div class="header-center">
                <h1 class="welcome-text">Welcome back, <span class="user-name" id="userName">User</span>!</h1>
            </div>
            <div class="header-right">
                <span class="role-badge" id="roleBadge">USER</span>
                <button class="logout-btn glass-btn" onclick="logout()">Logout</button>
            </div>
        </header>

        <!-- Navigation Sidebar -->
        <nav class="sidebar glass-panel">
            <ul class="nav-links">
                <li class="active"><a href="/dashboard"><i class="fas fa-chart-pie"></i> Dashboard</a></li>
                <li><a href="/chat"><i class="fas fa-comments"></i> Chat</a></li>
                <li><a href="/clock"><i class="fas fa-clock"></i> Timer</a></li>
                <li><a href="/settings"><i class="fas fa-cog"></i> Settings</a></li>
            </ul>
            <div class="admin-link" id="adminLink" style="display: none;">
                <a href="/admin" class="admin-btn">
                    <i class="fas fa-crown"></i> Admin Panel
                </a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Stats Row -->
            <section class="stats-row">
                <!-- Stopwatch Sessions Card -->
                <div class="stat-card glass-panel">
                    <div class="stat-icon">‚è±Ô∏è</div>
                    <div class="stat-info">
                        <span class="stat-value" id="timerStarts">--</span>
                        <span class="stat-label">Timer Sessions</span>
                    </div>
                </div>

                <!-- Total Time Card -->
                <div class="stat-card glass-panel">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-info">
                        <span class="stat-value" id="avgSession">-- min</span>
                        <span class="stat-label">Avg Session</span>
                    </div>
                </div>

                <!-- Chat Activity Card -->
                <div class="stat-card glass-panel">
                    <div class="stat-icon">üí¨</div>
                    <div class="stat-info">
                        <span class="stat-value" id="totalMessages">--</span>
                        <span class="stat-label">Total Messages</span>
                    </div>
                </div>

                <!-- Users Card (Admin Only) -->
                <div class="stat-card glass-panel admin-only" id="usersCard" style="display: none;">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-info">
                        <span class="stat-value" id="totalUsers">--</span>
                        <span class="stat-label">Total Users</span>
                    </div>
                </div>
            </section>

            <!-- Content Grid -->
            <section class="content-grid">
                <!-- Global Chat Card -->
                <div class="chat-card glass-panel">
                    <div class="card-header">
                        <h2 class="card-title">üí¨ Global Chat</h2>
                        <div class="online-indicator">
                            <span class="online-dot"></span>
                            <span class="online-text" id="activeUsers">-- online</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <p class="card-desc">Join the community chat and connect with other devs.</p>
                        <a href="/chat" class="join-chat-btn glass-btn">Join Chat ‚Üí</a>
                    </div>
                </div>

                <!-- Activity History Card -->
                <div class="history-card glass-panel">
                    <div class="card-header">
                        <h2 class="card-title">üìä Your Activity</h2>
                        <span class="last-updated" id="lastUpdated">--</span>
                    </div>
                    <div class="history-list" id="activityList">
                        <div class="history-item">
                            <span class="history-icon">üìà</span>
                            <div class="history-content">
                                <span class="history-text">Total Sessions: <strong id="totalSessions">--</strong></span>
                                <span class="history-time">All time activity</span>
                            </div>
                        </div>
                        <div class="history-item">
                            <span class="history-icon">üë§</span>
                            <div class="history-content">
                                <span class="history-text">New Users Today: <strong id="newUsers">--</strong></span>
                                <span class="history-time">Community growth</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>


    </div>



    <script src="/static/js/timer-overlay.js"></script>
    <script>
        // ===== Dashboard Data Loading =====
        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserInfo();
            await loadDashboardData();
        });

        async function loadUserInfo() {
            const user = await getCurrentUser();
            if (user) {
                // Display username if available, otherwise fall back to email
                document.getElementById('userName').textContent = user.username || user.email.split('@')[0];

                // Update UI based on role
                const badge = document.getElementById('roleBadge');
                if (user.role === 'admin') {
                    badge.textContent = 'ADMIN';
                    badge.classList.add('admin');
                    document.getElementById('adminLink').style.display = 'block';
                    // Show admin-only stats
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'flex');
                } else {
                    badge.textContent = 'USER';
                    badge.classList.remove('admin');
                    document.getElementById('adminLink').style.display = 'none';
                    // Hide admin-only stats
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                }
            }
        }

        async function loadDashboardData() {
            try {
                const response = await authFetch('/api/dashboard');
                if (!response || !response.ok) {
                    console.error('Failed to load dashboard');
                    return;
                }

                const data = await response.json();

                // User Stats
                document.getElementById('totalUsers').textContent = data.user_stats.total_users;
                document.getElementById('activeUsers').textContent = data.user_stats.active_users + ' online';
                document.getElementById('newUsers').textContent = data.user_stats.new_users_today;

                // Global Metrics
                document.getElementById('totalMessages').textContent = data.global_metrics.total_messages_sent;
                document.getElementById('timerStarts').textContent = data.global_metrics.total_timer_starts;

                // Activity
                document.getElementById('totalSessions').textContent = data.activity_summary.total_sessions;
                document.getElementById('avgSession').textContent =
                    data.activity_summary.average_session_minutes.toFixed(1) + ' min';

                // Timestamp
                document.getElementById('lastUpdated').textContent =
                    'Updated: ' + new Date(data.last_updated).toLocaleTimeString('en-IN', {
                        hour: '2-digit',
                        minute: '2-digit',
                        timeZone: 'Asia/Kolkata'
                    });

            } catch (error) {
                console.error('Dashboard load error:', error);
            }
        }

        // ===== Draggable Window - REMOVED =====
    </script>
</body>

</html>